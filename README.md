# STM32F103C8T6 智能农业监控系统

## 📋 项目简介

基于STM32F103C8T6的智能农业监控系统，支持温湿度监测、土壤湿度检测、光照强度测量，并通过ESP8266实现WiFi云端控制。

## 🎯 主要功能

- 🌡️ **温湿度监测**：DHT11传感器实时监测环境温湿度
- 🌱 **土壤湿度检测**：土壤湿度传感器监测土壤含水量
- ☀️ **光照强度测量**：BH1750传感器测量环境光照
- 📡 **WiFi云端控制**：ESP8266连接巴法云/阿里云
- 💧 **自动灌溉控制**：继电器控制水泵自动浇水
- 📺 **OLED显示**：实时显示传感器数据
- 🔘 **按键控制**：4个按键实现手动控制
- ⏰ **RTC时钟**：实时时钟功能

## 🔧 硬件配置

### 主控芯片
- STM32F103C8T6（ARM Cortex-M3，72MHz）

### 传感器模块
- DHT11 温湿度传感器
- 土壤湿度传感器（模拟输出）
- BH1750 光照传感器（I2C）

### 执行器
- 继电器模块（控制水泵）
- 蜂鸣器（报警提示）

### 通信模块
- ESP8266 WiFi模块（UART）
- USB转TTL（调试串口）

### 显示与交互
- 0.96寸OLED显示屏（I2C）
- 4个按键

## 📌 引脚分配

详细引脚连接请查看：[STM32F103C8T6完整硬件连接图.md](STM32F103C8T6完整硬件连接图.md)

### 关键引脚
| 引脚 | 功能 |
|------|------|
| PA0 | 蜂鸣器 |
| PA1 | 继电器 |
| PA2 | ESP8266 TX |
| PA3 | ESP8266 RX |
| PA7 | 土壤湿度传感器 |
| PB6/PB7 | BH1750 (I2C) |
| PB8/PB9 | OLED (I2C) |
| PB12 | DHT11 |

## 📁 项目结构

```
项目根目录/
├── HardWare/           # 硬件驱动层
│   ├── AD.c/h         # ADC驱动
│   ├── BH1750.c/h     # 光照传感器
│   ├── buzzer.c/h     # 蜂鸣器
│   ├── dht11.c/h      # 温湿度传感器
│   ├── esp8266.c/h    # WiFi模块
│   ├── key.c/h        # 按键
│   ├── LED.c/h        # LED
│   ├── MyRTC.c/h      # RTC时钟
│   ├── OLED.c/h       # OLED显示
│   ├── relay.c/h      # 继电器
│   ├── Serial.c/h     # 串口
│   └── Soil.c/h       # 土壤传感器
├── System/             # 系统层
│   ├── Delay.c/h      # 延时函数
│   ├── Initialization.c/h  # 系统初始化
│   ├── sys.c/h        # 系统配置
│   └── Task.c/h       # 任务调度器
├── User/               # 应用层
│   ├── main.c/h       # 主程序
│   ├── menu.c/h       # 菜单系统
│   └── stm32f10x_it.c/h  # 中断处理
├── Library/            # STM32标准库
├── Start/              # 启动文件
└── project.uvprojx     # Keil项目文件
```

## 🚀 快速开始

### 1. 环境准备
- Keil MDK 5.x
- STM32F10x标准库
- ST-Link或J-Link下载器

### 2. 编译项目
1. 打开 `project.uvprojx`
2. 选择目标：Target 1
3. 点击编译（F7）

### 3. 下载程序
1. 连接ST-Link到STM32
2. 点击下载（F8）

### 4. 硬件连接
按照 [硬件连接图](STM32F103C8T6完整硬件连接图.md) 连接所有模块

### 5. 运行测试
- 上电后OLED显示温湿度数据
- 按键1：连接巴法云
- 按键2：更新WiFi状态
- 按键3：手动控制继电器
- 按键4：手动上传数据

## 📡 云端配置

### 巴法云配置
在 `HardWare/esp8266.h` 中修改：
```c
#define BAFA_PRODUCT_ID   "你的产品ID"
#define BAFA_TOPIC_CONTROL "控制主题"
#define BAFA_TOPIC_DATA "数据主题"
```

### 阿里云配置
```c
#define ALI_PRODUCT_KEY   "你的产品Key"
#define ALI_DEVICE_NAME "设备名称"
#define ALI_DEVICE_SECRET "设备密钥"
```

## 🔧 功能说明

### 自动模式
- 系统自动读取传感器数据
- 根据阈值自动控制继电器
- 定时上传数据到云端

### 手动模式
- 按键3切换到手动模式
- 手动控制继电器开关
- 手动上传数据

### 云端控制
支持通过云端下发控制指令：
```json
{
  "Relay": 1,        // 继电器控制 (0/1)
  "LED": 1,          // LED控制 (0/1)
  "TempThreshold": 30.0,  // 温度阈值
  "HumiThreshold": 60.0   // 湿度阈值
}
```

## 📊 数据格式

### 上传数据格式
```json
{
  "Temp": 25.5,      // 温度
  "Humi": 60.2,      // 湿度
  "Status": "Normal", // 状态
  "Relay": "ON"      // 继电器状态
}
```

## 🛠️ 维护说明

### 清理编译文件
运行 `keilkill.bat` 清理编译输出

### 清理项目冗余
运行 `清理项目冗余.bat` 删除测试文件夹

## ⚠️ 注意事项

1. **引脚冲突**：土壤湿度传感器使用PA7，不要与ESP8266的PA2冲突
2. **电源供电**：ESP8266需要稳定的3.3V供电，电流至少200mA
3. **I2C地址**：BH1750的ADDR引脚接GND，地址为0x46
4. **DHT11时序**：DHT11对时序要求严格，确保延时准确

## 📝 更新日志

### v1.0.0 (2024-xx-xx)
- ✅ 完成基础硬件驱动
- ✅ 实现任务调度系统
- ✅ 集成ESP8266 WiFi功能
- ✅ 支持巴法云和阿里云
- ✅ 修复引脚冲突问题

## 📄 许可证

本项目仅供学习交流使用。

## 👥 贡献

欢迎提交Issue和Pull Request！

## 📧 联系方式

如有问题，请提交Issue。
