# å…¨å±€æ•°æ®ç»“æ„ä½¿ç”¨æ–¹æ¡ˆ - åœŸå£¤æ¹¿åº¦æ•°æ®å­˜å‚¨

## ğŸ“‹ å½“å‰æ•°æ®ç»“æ„åˆ†æ

### ç°æœ‰çš„æ•°æ®ç»“æ„å®šä¹‰ï¼ˆUser/main.hï¼‰

```c
// å˜é‡ç»“æ„ä½“ - å­˜å‚¨ä¼ æ„Ÿå™¨å®æ—¶æ•°æ®
typedef struct 
{
    float Temp;      // æ¸©åº¦
    float Humi;      // æ¹¿åº¦
    float MH_RD;     // é¢„ç•™å­—æ®µï¼ˆå¯èƒ½æ˜¯åœŸå£¤ç›¸å…³ï¼‰
} var;

// é˜ˆå€¼ç»“æ„ä½“ - å­˜å‚¨æ§åˆ¶é˜ˆå€¼
typedef struct 
{
    float Temp;      // æ¸©åº¦é˜ˆå€¼
    float Humi;      // æ¹¿åº¦é˜ˆå€¼
} thresh;

// æ ‡å¿—ä½ç»“æ„ä½“ - å­˜å‚¨çŠ¶æ€æ ‡å¿—
typedef struct 
{
    u8 i;
    u8 mode;
    u8 key1, key2, key3, key4;
    int x, y, z;
    u8 led;
    u16 motor_flag;
} flg;

// æ€»æ•°æ®ç»“æ„
typedef struct 
{
    var Variable;       // å˜é‡æ•°æ®
    thresh Threshold;   // é˜ˆå€¼æ•°æ®
    flg flag;           // æ ‡å¿—ä½
} dt;

extern dt data;  // å…¨å±€æ•°æ®å¯¹è±¡
```

## ğŸ¯ æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ç°æœ‰çš„MH_RDå­—æ®µï¼ˆæ¨èï¼‰â­

### å®ç°ä»£ç 
```c
void Update_TempHuim_Display(void)
{
    DHT11_Read_Data(&temp, &humi);
    
    // æ›´æ–°æ¸©æ¹¿åº¦åˆ°å…¨å±€æ•°æ®ç»“æ„
    data.Variable.Temp = (float)temp;
    data.Variable.Humi = (float)humi;
    
    static float Humi_Soil;
    Humi_Soil = Get_SoilHumi(ADC_Channel_7, 10);
    
    // æ›´æ–°åœŸå£¤æ¹¿åº¦åˆ°å…¨å±€æ•°æ®ç»“æ„ï¼ˆä½¿ç”¨MH_RDå­—æ®µï¼‰
    data.Variable.MH_RD = Humi_Soil;
    
    // ... æ˜¾ç¤ºä»£ç 
}
```

### ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ

#### 1. **æ•°æ®ç»“æ„å·²ç»é¢„ç•™äº†å­—æ®µ**
```c
typedef struct 
{
    float Temp;      // æ¸©åº¦
    float Humi;      // æ¹¿åº¦
    float MH_RD;     // â† è¿™ä¸ªå­—æ®µå¯èƒ½å°±æ˜¯ä¸ºåœŸå£¤æ¹¿åº¦é¢„ç•™çš„ï¼
} var;
```
- `MH_RD` å¯èƒ½ä»£è¡¨ "Moisture Humidity - Read" æˆ–ç±»ä¼¼å«ä¹‰
- å·²ç»å­˜åœ¨çš„å­—æ®µï¼Œç›´æ¥ä½¿ç”¨å³å¯

#### 2. **ä¿æŒæ•°æ®ç»“æ„ä¸€è‡´æ€§**
```c
// æ¸©åº¦å’Œæ¹¿åº¦çš„å­˜å‚¨æ–¹å¼
data.Variable.Temp = (float)temp;  // å­˜å‚¨åˆ°Variableç»“æ„ä½“çš„Tempå­—æ®µ
data.Variable.Humi = (float)humi;  // å­˜å‚¨åˆ°Variableç»“æ„ä½“çš„Humiå­—æ®µ

// åœŸå£¤æ¹¿åº¦ä¹Ÿåº”è¯¥å­˜å‚¨åˆ°Variableç»“æ„ä½“
data.Variable.MH_RD = Humi_Soil;   // å­˜å‚¨åˆ°Variableç»“æ„ä½“çš„MH_RDå­—æ®µ
```

#### 3. **ä¾¿äºå…¶ä»–æ¨¡å—è®¿é—®**
```c
// åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®è¿™äº›æ•°æ®
float current_temp = data.Variable.Temp;      // è¯»å–æ¸©åº¦
float current_humi = data.Variable.Humi;      // è¯»å–æ¹¿åº¦
float current_soil = data.Variable.MH_RD;     // è¯»å–åœŸå£¤æ¹¿åº¦

// ä¾‹å¦‚åœ¨äº‘ç«¯ä¸Šä¼ å‡½æ•°ä¸­
void upload_data(void) {
    sprintf(buff, 
        "{\"Temp\":%.1f,\"Humi\":%.1f,\"Soil\":%.1f}",
        data.Variable.Temp,
        data.Variable.Humi,
        data.Variable.MH_RD  // å¯ä»¥ç›´æ¥ä½¿ç”¨
    );
}
```

#### 4. **æ”¯æŒè‡ªåŠ¨æ§åˆ¶é€»è¾‘**
```c
// åœ¨æŠ¥è­¦æˆ–æ§åˆ¶å‡½æ•°ä¸­
void Alarm(void) {
    // æ ¹æ®åœŸå£¤æ¹¿åº¦è‡ªåŠ¨æ§åˆ¶ç»§ç”µå™¨
    if(data.Variable.MH_RD < 30.0) {  // åœŸå£¤å¤ªå¹²
        relay_ON();   // å¼€å¯æµ‡æ°´
    } else if(data.Variable.MH_RD > 70.0) {  // åœŸå£¤æ¹¿æ¶¦
        relay_OFF();  // å…³é—­æµ‡æ°´
    }
}
```

## ğŸ¯ æ–¹æ¡ˆäºŒï¼šæ·»åŠ æ–°çš„Soilå­—æ®µï¼ˆæ›´æ¸…æ™°ï¼‰

### ä¿®æ”¹æ•°æ®ç»“æ„ï¼ˆéœ€è¦ä¿®æ”¹main.hï¼‰
```c
// ä¿®æ”¹å˜é‡ç»“æ„ä½“
typedef struct 
{
    float Temp;      // æ¸©åº¦
    float Humi;      // æ¹¿åº¦
    float Soil;      // åœŸå£¤æ¹¿åº¦ï¼ˆæ–°å¢ï¼‰
    float MH_RD;     // ä¿ç•™åŸå­—æ®µ
} var;
```

### å®ç°ä»£ç 
```c
void Update_TempHuim_Display(void)
{
    DHT11_Read_Data(&temp, &humi);
    
    data.Variable.Temp = (float)temp;
    data.Variable.Humi = (float)humi;
    
    static float Humi_Soil;
    Humi_Soil = Get_SoilHumi(ADC_Channel_7, 10);
    
    // æ›´æ–°åœŸå£¤æ¹¿åº¦åˆ°å…¨å±€æ•°æ®ç»“æ„
    data.Variable.Soil = Humi_Soil;
    
    // ... æ˜¾ç¤ºä»£ç 
}
```

### ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ

#### 1. **è¯­ä¹‰æ›´æ¸…æ™°**
```c
data.Variable.Soil  // ä¸€çœ‹å°±çŸ¥é“æ˜¯åœŸå£¤æ¹¿åº¦
vs
data.Variable.MH_RD // éœ€è¦çŒœæµ‹å«ä¹‰
```

#### 2. **ä»£ç å¯è¯»æ€§æ›´å¥½**
```c
// æ–¹æ¡ˆäºŒï¼šæ¸…æ™°æ˜äº†
if(data.Variable.Soil < 30.0) {
    relay_ON();
}

// æ–¹æ¡ˆä¸€ï¼šéœ€è¦ç†è§£MH_RDçš„å«ä¹‰
if(data.Variable.MH_RD < 30.0) {
    relay_ON();
}
```

## ğŸ¯ æ–¹æ¡ˆä¸‰ï¼šæ·»åŠ åœŸå£¤é˜ˆå€¼ï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰

### ä¿®æ”¹æ•°æ®ç»“æ„
```c
// å˜é‡ç»“æ„ä½“
typedef struct 
{
    float Temp;
    float Humi;
    float Soil;      // åœŸå£¤æ¹¿åº¦
} var;

// é˜ˆå€¼ç»“æ„ä½“ï¼ˆä¹Ÿæ·»åŠ åœŸå£¤é˜ˆå€¼ï¼‰
typedef struct 
{
    float Temp;
    float Humi;
    float Soil;      // åœŸå£¤æ¹¿åº¦é˜ˆå€¼
} thresh;
```

### å®ç°ä»£ç 
```c
void Update_TempHuim_Display(void)
{
    DHT11_Read_Data(&temp, &humi);
    
    data.Variable.Temp = (float)temp;
    data.Variable.Humi = (float)humi;
    
    static float Humi_Soil;
    Humi_Soil = Get_SoilHumi(ADC_Channel_7, 10);
    data.Variable.Soil = Humi_Soil;  // å­˜å‚¨å®æ—¶å€¼
    
    // ... æ˜¾ç¤ºä»£ç 
}

// åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®é˜ˆå€¼
void Data_Init(void) {
    data.Threshold.Temp = 30.0;  // æ¸©åº¦é˜ˆå€¼
    data.Threshold.Humi = 60.0;  // æ¹¿åº¦é˜ˆå€¼
    data.Threshold.Soil = 40.0;  // åœŸå£¤æ¹¿åº¦é˜ˆå€¼
}

// åœ¨æ§åˆ¶é€»è¾‘ä¸­ä½¿ç”¨
void Alarm(void) {
    if(data.Variable.Soil < data.Threshold.Soil) {
        relay_ON();  // åœŸå£¤æ¹¿åº¦ä½äºé˜ˆå€¼ï¼Œå¼€å¯æµ‡æ°´
    }
}
```

## ğŸ“Š ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | æ–¹æ¡ˆä¸€ï¼ˆä½¿ç”¨MH_RDï¼‰ | æ–¹æ¡ˆäºŒï¼ˆæ·»åŠ Soilï¼‰ | æ–¹æ¡ˆä¸‰ï¼ˆå®Œæ•´æ–¹æ¡ˆï¼‰ |
|------|-------------------|-------------------|-------------------|
| **ä¿®æ”¹ä»£ç é‡** | æœ€å°‘ï¼ˆ1è¡Œï¼‰ | ä¸­ç­‰ï¼ˆä¿®æ”¹ç»“æ„ä½“ï¼‰ | æœ€å¤šï¼ˆä¿®æ”¹å¤šå¤„ï¼‰ |
| **å¯è¯»æ€§** | ä¸€èˆ¬ | å¥½ | æœ€å¥½ |
| **æ‰©å±•æ€§** | ä¸€èˆ¬ | å¥½ | æœ€å¥½ |
| **æ¨èåº¦** | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |

## ğŸ” ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å…¨å±€æ•°æ®ç»“æ„ï¼Ÿ

### 1. **æ•°æ®é›†ä¸­ç®¡ç†**
```c
// ä¸ä½¿ç”¨å…¨å±€ç»“æ„ï¼ˆåˆ†æ•£ï¼‰
float temp_value;
float humi_value;
float soil_value;
// æ•°æ®åˆ†æ•£åœ¨å„å¤„ï¼Œéš¾ä»¥ç®¡ç†

// ä½¿ç”¨å…¨å±€ç»“æ„ï¼ˆé›†ä¸­ï¼‰
data.Variable.Temp
data.Variable.Humi
data.Variable.Soil
// æ‰€æœ‰æ•°æ®é›†ä¸­åœ¨ä¸€ä¸ªç»“æ„ä½“ä¸­
```

### 2. **ä¾¿äºæ¨¡å—é—´é€šä¿¡**
```c
// æ˜¾ç¤ºæ¨¡å—
void Display(void) {
    OLED_ShowNum(0, 0, data.Variable.Temp, 2, OLED_6X8);
}

// æ§åˆ¶æ¨¡å—
void Control(void) {
    if(data.Variable.Temp > data.Threshold.Temp) {
        // æ¸©åº¦è¿‡é«˜ï¼Œæ‰§è¡Œé™æ¸©
    }
}

// ä¸Šä¼ æ¨¡å—
void Upload(void) {
    sprintf(buff, "{\"Temp\":%.1f}", data.Variable.Temp);
}

// ä¸‰ä¸ªæ¨¡å—éƒ½è®¿é—®åŒä¸€ä¸ªæ•°æ®æºï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
```

### 3. **æ”¯æŒæ•°æ®æŒä¹…åŒ–**
```c
// å¯ä»¥å°†æ•´ä¸ªç»“æ„ä½“ä¿å­˜åˆ°Flash
void Save_Data(void) {
    Flash_Write(&data, sizeof(dt));
}

// å¯ä»¥ä»Flashæ¢å¤æ•°æ®
void Load_Data(void) {
    Flash_Read(&data, sizeof(dt));
}
```

### 4. **ä¾¿äºè°ƒè¯•**
```c
// å¯ä»¥ä¸€æ¬¡æ€§æŸ¥çœ‹æ‰€æœ‰æ•°æ®
void Debug_Print(void) {
    Serial_Printf("Temp: %.1f\r\n", data.Variable.Temp);
    Serial_Printf("Humi: %.1f\r\n", data.Variable.Humi);
    Serial_Printf("Soil: %.1f\r\n", data.Variable.Soil);
    Serial_Printf("Mode: %d\r\n", data.flag.mode);
}
```

## ğŸ’¡ å®ç°åŸç†

### æ•°æ®æµå‘
```
ä¼ æ„Ÿå™¨è¯»å– â†’ å±€éƒ¨å˜é‡ â†’ å…¨å±€ç»“æ„ä½“ â†’ å…¶ä»–æ¨¡å—ä½¿ç”¨

DHT11_Read_Data(&temp, &humi)
        â†“
    temp, humi (å±€éƒ¨å˜é‡)
        â†“
    data.Variable.Temp = temp
    data.Variable.Humi = humi
        â†“
    å…¨å±€æ•°æ®ç»“æ„ (data)
        â†“
    â”œâ”€â†’ æ˜¾ç¤ºæ¨¡å—è¯»å–
    â”œâ”€â†’ æ§åˆ¶æ¨¡å—è¯»å–
    â”œâ”€â†’ ä¸Šä¼ æ¨¡å—è¯»å–
    â””â”€â†’ å…¶ä»–æ¨¡å—è¯»å–
```

### å†…å­˜å¸ƒå±€
```c
// å…¨å±€æ•°æ®ç»“æ„åœ¨å†…å­˜ä¸­çš„å¸ƒå±€
dt data = {
    .Variable = {
        .Temp = 0.0,    // åç§»é‡: 0
        .Humi = 0.0,    // åç§»é‡: 4
        .MH_RD = 0.0    // åç§»é‡: 8
    },
    .Threshold = {
        .Temp = 0.0,    // åç§»é‡: 12
        .Humi = 0.0     // åç§»é‡: 16
    },
    .flag = {
        // ...
    }
};

// è®¿é—®æ—¶é€šè¿‡åç§»é‡è®¡ç®—åœ°å€
data.Variable.Temp  â†’ &data + 0
data.Variable.Humi  â†’ &data + 4
data.Variable.MH_RD â†’ &data + 8
```

## ğŸ¯ æ¨èå®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šä½¿ç”¨ç°æœ‰å­—æ®µï¼ˆæœ€ç®€å•ï¼‰
```c
// åœ¨Update_TempHuim_Displayå‡½æ•°ä¸­æ·»åŠ ä¸€è¡Œ
data.Variable.MH_RD = Humi_Soil;
```

### æ­¥éª¤2ï¼šåœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨
```c
// åœ¨ä¸Šä¼ å‡½æ•°ä¸­
sprintf(buff, 
    "{\"Temp\":%.1f,\"Humi\":%.1f,\"Soil\":%.1f}",
    data.Variable.Temp,
    data.Variable.Humi,
    data.Variable.MH_RD
);

// åœ¨æ§åˆ¶å‡½æ•°ä¸­
if(data.Variable.MH_RD < 30.0) {
    relay_ON();
}
```

### æ­¥éª¤3ï¼šï¼ˆå¯é€‰ï¼‰é‡å‘½åå­—æ®µ
```c
// å¦‚æœè§‰å¾—MH_RDä¸å¤Ÿæ¸…æ™°ï¼Œå¯ä»¥åœ¨main.hä¸­é‡å‘½å
typedef struct 
{
    float Temp;
    float Humi;
    float Soil;  // æ”¹åä¸ºSoilï¼Œæ›´æ¸…æ™°
} var;
```

## âœ… æ€»ç»“

**æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€**ï¼š
```c
data.Variable.MH_RD = Humi_Soil;
```

**åŸå› **ï¼š
1. âœ… ä¸éœ€è¦ä¿®æ”¹æ•°æ®ç»“æ„å®šä¹‰
2. âœ… åªéœ€æ·»åŠ ä¸€è¡Œä»£ç 
3. âœ… ç«‹å³å¯ç”¨
4. âœ… ä¸æ¸©æ¹¿åº¦å­˜å‚¨æ–¹å¼ä¸€è‡´
5. âœ… ä¾¿äºå…¶ä»–æ¨¡å—è®¿é—®

**æ ¸å¿ƒåŸç†**ï¼š
- å…¨å±€æ•°æ®ç»“æ„æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£
- æ‰€æœ‰æ¨¡å—é€šè¿‡åŒä¸€ä¸ªç»“æ„ä½“è®¿é—®æ•°æ®
- ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§