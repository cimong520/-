# 土壤湿度显示问题修复报告

## 🔍 问题分析

您的土壤湿度显示函数存在以下问题：

### 1. ❌ 显示位置超出屏幕范围

**原代码**：
```c
OLED_ShowString(6*17, 0, "soil", OLED_6X8);  // X坐标 = 102
OLED_ShowNum(6*22, 0, Humi_Soil, 2, OLED_6X8);  // X坐标 = 132
```

**问题**：
- OLED屏幕宽度只有128像素（X坐标范围：0-127）
- `6*17 = 102` 可以显示，但空间不够
- `6*22 = 132` **超出屏幕范围**，完全不会显示！

### 2. ❌ 缺少OLED_Update()调用

**原代码**：
```c
OLED_ShowString(6*17, 0, "soil", OLED_6X8);
OLED_ShowNum(6*22, 0, Humi_Soil, 2, OLED_6X8);
// 缺少 OLED_Update();
```

**问题**：
- OLED显示函数只是将数据写入显存数组
- **必须调用`OLED_Update()`才能将显存数据刷新到屏幕**
- 没有调用Update，屏幕上不会显示任何内容

### 3. ⚠️ 数据类型不匹配

**原代码**：
```c
float Humi_Soil;  // 浮点数
OLED_ShowNum(6*22, 0, Humi_Soil, 2, OLED_6X8);  // ShowNum只能显示整数
```

**问题**：
- `Get_SoilHumi()`返回float类型（带小数）
- `OLED_ShowNum()`只能显示整数，会丢失小数部分
- 应该使用`OLED_ShowFloatNum()`显示浮点数

### 4. ⚠️ 与温湿度显示位置冲突

**原代码**：
```c
// 温湿度显示在第0行
OLED_ShowString(6*0, 0, "temp", OLED_6X8);
OLED_ShowString(6*8, 0, "humi", OLED_6X8);

// 土壤湿度也显示在第0行
OLED_ShowString(6*17, 0, "soil", OLED_6X8);
```

**问题**：
- 两个函数都在第0行显示，会相互覆盖
- 需要分开显示在不同行

## ✅ 修复方案

### 修复后的代码

```c
//土壤湿度显示函数
void Update_Soil_Moisture(void)
{
    static float Humi_Soil;
    Humi_Soil = Get_SoilHumi(SOIL_HUMI_ADC_CHANNEL, 10);  // 使用宏定义
    
    // 显示在第二行（Y=8），避免与温湿度重叠
    OLED_ShowString(0, 8, "Soil:", OLED_6X8);              // X=0, Y=8
    OLED_ShowFloatNum(6*6, 8, Humi_Soil, 3, 1, OLED_6X8); // X=36, Y=8, 显示浮点数
    OLED_ShowChar(6*10, 8, '%', OLED_6X8);                // X=60, Y=8
    
    // 更新显示（关键！）
    OLED_Update();
}
```

### 修复说明

1. ✅ **修复显示位置**
   - 改为显示在第二行（Y=8）
   - X坐标从0开始，确保不超出屏幕

2. ✅ **添加OLED_Update()**
   - 在显示完成后调用`OLED_Update()`
   - 将显存数据刷新到屏幕

3. ✅ **使用正确的显示函数**
   - 使用`OLED_ShowFloatNum()`显示浮点数
   - 参数：X, Y, 数值, 整数位数, 小数位数, 字体大小

4. ✅ **避免位置冲突**
   - 温湿度显示在第一行（Y=0）
   - 土壤湿度显示在第二行（Y=8）
   - 温度曲线显示在下方（Y=20-60）

## 📺 屏幕布局

```
┌────────────────────────────────┐
│ temp:25 humi:60        (Y=0)   │  ← 温湿度
│ Soil:45.5%             (Y=8)   │  ← 土壤湿度
│                                │
│    温度曲线图          (Y=20)  │
│                                │
│                        (Y=60)  │
└────────────────────────────────┘
  0                           127
```

## 🔧 坐标计算说明

### OLED_6X8字体
- 每个字符宽度：6像素
- 每个字符高度：8像素

### 显示位置计算
```c
// 第一行（Y=0）
"temp" at X=0    → 占用 0-23 像素
数字   at X=30   → 占用 30-41 像素
"humi" at X=48   → 占用 48-71 像素
数字   at X=78   → 占用 78-89 像素

// 第二行（Y=8）
"Soil:" at X=0   → 占用 0-29 像素
数字    at X=36  → 占用 36-59 像素
"%"     at X=60  → 占用 60-65 像素
```

## 🎯 验证步骤

1. **编译项目**
   ```
   应该没有编译错误
   ```

2. **下载到板子**
   ```
   使用ST-Link下载程序
   ```

3. **观察OLED屏幕**
   ```
   第一行：temp:XX humi:XX
   第二行：Soil:XX.X%
   下方：温度曲线
   ```

4. **检查数值变化**
   ```
   - 改变土壤湿度（浸水/晾干）
   - 观察数值是否变化
   - 数值范围应该在0-100%之间
   ```

## 💡 其他优化建议

### 1. 添加数据有效性检查
```c
void Update_Soil_Moisture(void)
{
    static float Humi_Soil;
    Humi_Soil = Get_SoilHumi(SOIL_HUMI_ADC_CHANNEL, 10);
    
    // 限制数值范围
    if(Humi_Soil < 0) Humi_Soil = 0;
    if(Humi_Soil > 100) Humi_Soil = 100;
    
    OLED_ShowString(0, 8, "Soil:", OLED_6X8);
    OLED_ShowFloatNum(6*6, 8, Humi_Soil, 3, 1, OLED_6X8);
    OLED_ShowChar(6*10, 8, '%', OLED_6X8);
    OLED_Update();
}
```

### 2. 添加状态指示
```c
// 根据湿度显示状态
if(Humi_Soil < 30) {
    OLED_ShowString(6*12, 8, "DRY", OLED_6X8);
} else if(Humi_Soil > 70) {
    OLED_ShowString(6*12, 8, "WET", OLED_6X8);
} else {
    OLED_ShowString(6*12, 8, "OK ", OLED_6X8);
}
```

### 3. 优化显示更新
```c
// 只在数值变化时更新显示
static float last_Humi_Soil = -1;
if(Humi_Soil != last_Humi_Soil) {
    // 更新显示
    last_Humi_Soil = Humi_Soil;
}
```

## ✅ 修复完成

现在土壤湿度应该能正常显示了！

**关键点总结**：
1. ✅ 显示位置在屏幕范围内（X < 128）
2. ✅ 调用了OLED_Update()刷新屏幕
3. ✅ 使用ShowFloatNum显示浮点数
4. ✅ 避免了与其他显示内容冲突

如果还有问题，请检查：
- AD_Init()是否正确初始化
- 传感器是否正确连接到PA7
- Get_SoilHumi()函数是否返回正确数值